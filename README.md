# Pilgrim Unity SDK

[![CircleCI](https://circleci.com/gh/foursquare/pilgrim-unity-sdk/tree/master.svg?style=svg&circle-token=b6e777cc57a0d65b6ee58e576ca64858c5eb3339)](https://circleci.com/gh/foursquare/pilgrim-unity-sdk/tree/master)

Pilgrim Unity SDK is a package which enables easy integration with the [Pilgrim SDK](https://enterprise.foursquare.com/products/pilgrim) in a Unity project. This package supports a subset of the iOS and Android SDKs which currently includes the following functionality:

* Passive location detection with notifications received via [Webhooks](https://developer.foursquare.com/docs/pilgrim-sdk/webhooks) and other [third-party integrations](https://developer.foursquare.com/docs/pilgrim-sdk/integrations)
* Getting the user's [Current Location](https://developer.foursquare.com/docs/pilgrim-sdk/quickstart#get-current-location)
* Sending [Custom User Data](https://developer.foursquare.com/docs/pilgrim-sdk/advanced-setup-guide#custom-user-data)

Pilgrim SDK dependencies for iOS and Android are managed via the [Play Services Resolver](https://github.com/googlesamples/unity-jar-resolver), which is included with the package.

## Table of Contents
* [Requirements](#requirements)
* [Installing](#installing)
* [Usage](#usage) 
    * [Application Setup](#application-setup)
    * [PilgrimUnitySDK C# Class](#pilgrimunitysdk-c-class)
    * [Location Permissions](#location-permissions)
    * [Getting User's Current Location](#getting-users-current-location)
    * [Passive Location Detection](#passive-location-detection)
    * [Sending Custom User Data](#sending-custom-user-data)
    * [Mocking Editor Locations](#mocking-editor-locations)
* [FAQ](#faq)

## Requirements

This package has been tested with the following Unity versions:

* 2018.3.3f1 *haven't tested*
* 2018.3.2f1
* 2018.2.20f1 *haven't tested*
* 2018.1.9f2 *haven't tested*
* 2017.2.5f1 *haven't tested*
* 2017.1.5f1 *haven't tested*

The iOS SDK requires iOS 8+ and the Android SDK requires API level 15+ (ICE_CREAM_SANDWICH_MR1).  Additionally, to build for iOS you must have [CocoaPods](https://cocoapods.org/) installed.

## Installing

Download the latest release from the [Releases](https://github.com/foursquare/pilgrim-unity-sdk/releases) page, it will list which versions of Pilgrim it supports for iOS and Android.  In Unity select the menu item `Assets/Import Package/Custom Package` and open the downloaded package. The package comes with the latest version of the [Play Services Resolver](https://github.com/googlesamples/unity-jar-resolver) available when the package was built.  If your current platform in build settings is Android, or when you switch to Android, the Play Services Resolver will resolve and download the Android dependencies to `Assets/Plugins/Android`. For iOS the Play Services Resolver will run `pod install` when you build for iOS. It will generate an Xcode workspace with Pilgrim iOS SDK added as a Pod.



## Usage

If you do not have a Foursquare API key whitelisted for Pilgrim access, read our guide on [Foursquare API Access](https://developer.foursquare.com/docs/pilgrim-sdk).

### Application Setup

The first step is configuring your project to work properly with Pilgrim SDK:
* Select the menu item `Assets\Pilgrim Unity SDK\Configuration` and input your consumer key and secret and press Save
* For iOS there is also an option to copy the string set in `Location Usage Description` in `Player Settings` to the `NSLocationAlwaysAndWhenInUseUsageDescription` entry in the `Info.plist` when building, which is required for passive location detection.
* Ensure you set the `Bundle Identifier` for iOS and `Package Name` for Android in Player Settings.
* For iOS you must enable the background location capability by setting `Behavior in Background` to `Custom` in `Player Settings` and checking `Location updates`. Also ensure you have added a description in `Location Usage Description` in `Player Settings`.
* For the Android SDK to authenticate with our server you will also need to set your Android Key Hash on your Foursquare app settings page, more info [here](https://developer.foursquare.com/docs/pilgrim-sdk/quickstart#android). Then you need to configure Unity to use your keystore in the `Publishing Settings` section of `Player Settings`.

The next step is ensuring Pilgrim Unity SDK is started on application launch:

#### iOS

 You must call `[PilgrimUnitySDK initWithConsumerKey:consumerSecret:]` from `application:didFinishLaunchingWithOptions` in a `UnityAppController` subclass. You can have the `UnityAppController` subclass autogenerated and added to the project by selecting the menu item `Assets\Pilgrim Unity SDK\iOS\Generate AppController.m`. 

Alternatively, if you already have a `UnityAppController` subclass or need to do this manually ensure you call `[PilgrimUnitySDK initWithConsumerKey:consumerSecret:]` as described above, for example:

```
// MyAppController.m
#import "UnityAppController.h"
#import "PilgrimUnitySDK.h"

@interface MyAppController : UnityAppController

@end

IMPL_APP_CONTROLLER_SUBCLASS(MyAppController)

@implementation MyAppController

- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)options {
    [PilgrimUnitySDK initWithConsumerKey:@"CONSUMER_KEY" consumerSecret:@"CONSUMER_SECRET"];

    // Other code

    return [super application:application didFinishLaunchingWithOptions:options]; 
}

@end

```

Then add the .m file to `Assets/Plugins/iOS`.  You can learn more about the `UnityAppController` class [here](https://docs.unity3d.com/Manual/StructureOfXcodeProject.html)

#### Android

You must call `PilgrimUnitySDK.init` from the `onCreate` method in an `android.app.Application` subclass. You can have the `android.app.Application` subclass autogenerated and added to the project by selecting the menu item `Assets\Pilgrim Unity SDK\Android\Generate App.java`. Additionally, you need to create an `AndroidManifest.xml` that sets up the app to use your `android.app.Application` subclass.  This can also be autogenerated and added to the project by selecting the menu item `Assets\Pilgrim Unity SDK\Android\Generate AndroidManifest.xml`.  

Alternatively, if you already have an `android.app.Application` subclass or need to do this manually ensure you call `PilgrimUnitySDK.init` as described above, for example:

```
package com.company.app;

// App.java

import android.app.Application;

import com.foursquare.pilgrimunitysdk.PilgrimUnitySDK;

public final class MyApp extends Application {

    @Override
    public void onCreate() {
        super.onCreate();
        PilgrimUnitySDK.init(this, "CONSUMER_KEY", "CONSUMER_SECRET");
    }

}
```

Also ensure your `AndroidManifest.xml` sets the `android.app.Application` subclass properly, for example:

```
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android" package="com.company.app" xmlns:tools="http://schemas.android.com/tools" android:installLocation="preferExternal">
  <supports-screens android:smallScreens="true" android:normalScreens="true" android:largeScreens="true" android:xlargeScreens="true" android:anyDensity="true" />
  <application android:name="com.company.app.MyApp" android:theme="@style/UnityThemeSelector" android:icon="@mipmap/app_icon" android:label="@string/app_name">
    <activity android:name="com.unity3d.player.UnityPlayerActivity" android:label="@string/app_name">
      <intent-filter>
        <action android:name="android.intent.action.MAIN" />
        <category android:name="android.intent.category.LAUNCHER" />
      </intent-filter>
      <meta-data android:name="unityplayer.UnityActivity" android:value="true" />
    </activity>
  </application>
</manifest>
```
### PilgrimUnitySDK C# Class

All interactions with Pilgrim SDK in Unity happen through static methods in the `PilgrimUnitySDK` class in the `Foursquare` namespace.  `PilgrimUnitySDK` uses `System.Action` when it needs to communicate information back to the Unity application for [Location Permissions](#location-permissions) and [Getting User's Current Location](#getting-users-current-location)

### Location Permissions

***TODO***

### Getting User's Current Location

***TODO***

### Passive Location Detection

Passive location detection is controlled with the `PilgrimUnitySDK.Start()` and `PilgrimUnitySDK.Stop()` methods. When started Pilgrim SDK will send notifications to [Webhooks](https://developer.foursquare.com/docs/pilgrim-sdk/webhooks) and other [third-party integrations](https://developer.foursquare.com/docs/pilgrim-sdk/integrations).  Example usage below:

```
using Foursquare;
using UnityEngine;

public class GameManager : MonoBehaviour
{

    void OnEnable()
    {
        PilgrimUnitySDK.Start();
    }

    void OnDisable()
    {
        PilgrimUnitySDK.Stop();
    }

}
```

### Sending Custom User Data

Custom user data can be sent to Pilgrim to be passed along to other services using the `PilgrimUnitySDK.SetUserInfo` method.  More information on custom user data is available [here](https://developer.foursquare.com/docs/pilgrim-sdk/advanced-setup-guide#custom-user-data). Example usage below:

```
using Foursquare;
using UnityEngine;

public class GameManager : MonoBehaviour
{

    void Start()
    {
        var userInfo = new UserInfo();
        userInfo.SetUserId("user_id");
        userInfo.SetBirthday(new DateTime(2000, 1, 1));
        userInfo.SetGender(UserInfo.Gender.Female);
        userInfo.Set("key", "value");
        PilgrimUnitySDK.SetUserInfo(userInfo);
    }

}
```

### Mocking Editor Locations

***TODO***

## FAQ

***TODO***